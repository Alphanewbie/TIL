# 엘라스틱 서치 소개

루샨을 베이스로 하는 검색 엔진

### 기본 컨셉트

- 검색 엔진. 
  - 본격적인 전문 검색이 가능하며, 
  - 역색인을 사용하여 검색 속도 빠르다.
- 분산 처리, 
  - 분산 처리를 고려하여 설계됬다. 
  - 데이터를 여러 노드에 분석 저장하며 검색이나 집계 작업들을 수행할 때도 분신 처리를 지원
- 고가용성 제공,
  - 일부 노드에 장애가 발생해도 복제본 데이터를 사용해 중단 없이 서비스 지속, 이때 다시 복제본을 만들어 에러가 발생해도 복제본의 균형을 자동으로 맞춘다.
- 수평적 확장성
  - 더 많은 처리가 요구되는 때를 위해 수평적 확장 지원
  - 새로운 노드에 엘라스틱 서치를 설치하여 클러스터에 참여 시키는 걸로 간단하게 확장
  - 새 노드에 데이터를 복제도 자동 수행
- JSON 기반의 REST API 제공
  - 엘라스틱 서치는 JSON 형태의 문서를 저장, 색인 검색
  - 환경에 구애 받지 않고 HTTP를 이용해 쉽게 이용 가능
- 데이터 안정성
  - 데이터 색인 요청후 200 을 받았다면 그 데이터는 확실히 디스크에 저장
- 준 실시간 검색
  - 데이터를 색인하자마자 조회하는건 가능하지만, 색인 후 검색 요청은 성공하지 못할 가능성이 높다. -> 역색인으로부터 검색이 가능해지기 까지 시간이 걸리기 때문
- 트랜잭션이 지원되지 않음.
  - RDBMS와는 다르게 트랜잭션을 지원하지 않는다.
- 사실상 조인을 지원하지 않음
  - join을 염두에 두고 설계되지 않음.
  - 아주 제한적으로 상요된다고 생각해야한다.



# 엘라스틱 서치 기본 동작과 구조

## 엘라스틱 서치 기본 동작

### 문서 색인

- `_id`를 지정하여 색인

문서를 색인한 인덱스 이름, _id값을 지정하고 PUT을 이용해 호출

```
PUT [인덱스 이름]/_doc/[_id값]
{
	{문서 내용}
}
```

- _id값을 지정하지 않고 색인

_id값을 지정하지 않으면 자동으로 _id값을 생성해준다. POST을 이용해 호출

```
POST [인덱스 이름]/_doc
{
	{문서 내용}
}
```

### 문서 조회

문서를 조회할 때는 인덱스 이름과 _id값을 지정하여 GET 메소드로 호출

```
GET [인덱스 이름]/_doc/[_id]
```



### 문서 업데이트

문서를 업데이트 할 는 이름과 _id값을 지정한다.

_doc 대신 `_update`를 사용

```
POST [인덱스 이름]/_update/[_id값]
{
	"doc": {
		[문서 내용]
	}
}
```



특정 부분만 업데이트 하는 방법

```
POST [인덱스 이름]/_update/[_id값]
{
	"doc": {
		"title": "Test Title"
	}
}
```



### 문서 검색

문서 검색 쿼리를 위한 전횽 DSL 쿼리를 제공한다.

인덱스 이름을 지정하고 그 뒤에 _search를 붙혀 검색

- 검색 메소드는 GET과 POST를 둘다 동일하게 지원한다. 하지만 보편적으로 GET쪽을 더 많이 쓴다.



가장 기본적인 match 쿼리를 사용한 요청

```
GET my index/_search
{
	"query" : {
		"match" : {
			"title": "hello world"
		}
	}
}
```

이렇게 검색을 하게 되면 `hello world` 와 `hello elastic search`또한 검색 되지만 `_search`의 일치도가 좀 낮게 나온다.



## 구조 개괄

- 문서 : 엘라스틱 서치가 저장하고 색인을 생성하는 JSON문서
- 인덱스 : 문서를 모아놓은 단위, 클라이언트는 인덱스 단위로 검색을 요청
- 샤드 : 인덱스는 그 내용을 여러 샤드로 분리하여 분산 저장한다. 엘라스틱 서치는 고가용성을 제공하기 위해 샤드에 내용을 복제.
  - 주 샤드 : 원본 역할을 담당
  - 복제본 샤드 : 복제봄
- _id :  인덱스 내 문서에 부여되는 고유한 구분자. 인덱스 이름과 _id의 조합은 엘라스틱 서치 클러스터 내에서 고유
- 노드 : 엘라스틱 서치 프로세스 하나가 노드 하나를 구성한다. 엘라스틱 서치 노드 하나는 여러개의 샤드를 가진다.
- 클러스터 : 엘라스틱 서치 노드 여러개의 집합
- 노드의 역할 : 
  - 데이터 노드 : 실제 읽기와 쓰기 작업을 수행하는 노드
  - 마스터 노드 : 클라스터를 관리하는 역할을 하는 노드. 마스터 노트는 마스터 노드 후보 노드 중 하나에서 선추ㄹ된다.
  - 조정 노드 : 클라이언트의 요청을 받아서 데이터 노드에 요청을 분배하고, 클라이언트에게 응답을 돌려주는 노드



## 내부 구조와 루씬

엘라스틱서치는 아파치 루씬을 코어라이브러리로 사용하고 있다. 루씬은 문서를 색인하고 검색하는 라이브러리이다.

루씬은 파일을 연 시점에서 색인이 완료된 문서만 검색 할수 있고, 색인에 변경 사항이 발생했다고, 그 내용을 검색 결과에 반영하고 싶다면 파일을 새로 열어야 한다.

### 루씬 flush

문서 색인 요청이 들어오면 루씬은 문서를 분석해서 역색인을 생성한다. 최초 생성 자체는 메모리 버퍼에 들어간다. 문서 색인, 업데이트, 삭제 등의 작업이 수행되면 루씬은 이러한 변경들을 메모리에 들고 있다가 주기적으로 디스크에 flush한다.

단, 시스템 페이지 캐시에 데이터를 넘겨주는 것까지만 보장할 뿐 디스크에 파일이 안전하게 기록되는 것까지는 보장하지 않는다.

### 루씬 commit

fsync 시스템 콜을 통해 주기적으로 커널시스템의 페이지 캐시이 내용과 실제로 디스크에 기록된 내용의 싱크를 맞추는 작업을 루씬 commit 이라고 한다.

### 세그먼트

위의 과정을 거쳐 디스크에 기록된 파일들이 모이면 세그먼트라는 단위가 된다. 이 세그먼트가 루씬의 검색 대상이다. 세그먼트 자체는 불변인 데이터로 구성. 기존 문서를 삭제하는 경우 삭제 플래그만 표시

루씬의 검색은 모든 세그먼트를 대상으로 수행. 세그먼트의 개수를 무한정 늘릴 순 없기 때ㅔ문에 세그먼트 병합을 수행하는데, 이때 삭제 플래그가 표시된 데이터를 실제로 삭제

### 루씬 인덱스와 엘라스틱 서치 인덱스

여러 세그먼트가 모이면 하나의 루씬 인덱스. 루씬은 이 인덱스 내에서만 검색이 가능. 엘라스틱 서치 샤드는 이 루씬 인덱스 하나를 래핑한 단위

엘라그스틱 서치 샤드 여러개가 모이면 엘라스틱 서치 인덱스가 된다. 새 문서가 들어오면 여러 사드에 분산시켜 저장 색인한다. 이후 검색 요청을 보내면 엘라스틱 서치는 각 샤드를 대상으로 검색을 한 뒤에 그 결과를 모아 병합하여 최종 응답을 만든다.

엘라스틱 서치를 구성하는 샤드는 여러 모드에 분산되어 있고, 이러한 노드가 모여서 하나의 엘라스틱 서치 클러스터가 된다.

### translog

엘라스틱 서치는 commit 되어야 디스크에 안정하게 기록되는데, commit은 일일히 수행하기에 비용이 너무 크다. 이러한 문제를 해결하기 위해 엘라스틱 서치 샤드는 모든 작업마다 translog 라는 이름의 작업로그를 남긴다.

translog는 색인, 삭제 작업이 인덱스에 수행된 직후에 기록,  tanslog기록까지 끝난 이후에야 작업 요청이 성공으로 승인. Translog 기록은 성공 했지만, 루씬 commit 에 포함되지 않은 내용이 있다면 샤드 복구 단계에서 복원된다.

 

